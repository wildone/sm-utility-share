<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-meta/iron-meta.html">

<dom-module id="sm-utility-share">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <iron-meta id="meta" type="[[type]]" key="[[key]]" value="{{value}}"></iron-meta>
  </template>
  <script>
    import EventEmitter from 'eventemitter3';

    let instances = {},
        store = {},
        updating = false;

    const emitter = new EventEmitter();

    function makeKey(...args) {
      return args.join('.');
    }

    class SmUtilityShare {
      beforeRegister() {
        this.is = 'sm-utility-share';

        this.properties = {
          type: String,
          key: String,
          value: {
            type: String,
            observer: '_valueChanged',
            notify: true
          },
          readonly: {
            type: Boolean,
            value: false
          }
        }

        this.observers = [
          '_updateInstance(type, key)'
        ];
      }

      _updateInstance(type, key) {
        if (this.__listener && this.__key) {
          emitter.off(this.__key, this.__listener);
        }

        this.__key = makeKey(type, key);

        this.__listener = (value) => {
          if (!this.readonly) {
            this._updating = true;
            this.value = value;
            this._updating = false;
          }
        };

        emitter.on(this.__key, this.__listener);

        this._updating = true;
        this.value = store[this.__key];
        this._updating = false;
      }

      _valueChanged(value, previous) {
        const ready = this.__key && !this._updating && store[this.__key] !== value;

        if (ready) {
          emitter.emit(this.__key, value);
          store[this.__key] = value;
          // const toUpdate = instances[this.type][this.key]
          //                   .filter(element => element !== this);
          //
          // if (this.readonly) {
          //   this.value = previous;
          // } else if (!updating) {
          //   updating = true;
          //   toUpdate.forEach(element => element.value = value);
          //   updating = false;
          // }
        }
      }
    }

    window.inst = instances;

    Polymer(SmUtilityShare);
  </script>
</dom-module>
